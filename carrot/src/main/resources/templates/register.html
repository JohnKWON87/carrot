<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - 중고마켓</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff6b35;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: "♻️";
            font-size: 1.5rem;
        }

        .back-btn {
            background: #666;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #333;
            transform: translateY(-2px);
        }

        .container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .register-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
        }

        .register-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
            font-size: 2rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        .required {
            color: #e74c3c;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff6b35;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .register-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
        }

        .register-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .login-link {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }

        .login-link a {
            color: #ff6b35;
            text-decoration: none;
            font-weight: 500;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            border: none;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .form-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .validation-msg {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            min-height: 1rem;
        }

        .validation-msg.error {
            color: #e74c3c;
        }

        .validation-msg.success {
            color: #27ae60;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .register-card {
                margin: 1rem;
                padding: 2rem;
            }
        }

        /* register.html의 <style> 태그에 다음 CSS를 추가하세요 */

.validation-msg.checking {
    color: #3498db;
    font-style: italic;
}

.form-group input.valid {
    border-color: #27ae60;
    box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
}

.form-group input.invalid {
    border-color: #e74c3c;
    box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.1);
}

.register-btn:disabled {
    background: #bdc3c7 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

    </style>
</head>
<body>
<!-- 네비게이션 바 -->
<nav class="navbar">
    <div class="navbar-content">
        <a href="/" class="logo">중고마켓</a>
        <a href="/" class="back-btn">로그인으로 돌아가기</a>
    </div>
</nav>

<!-- 회원가입 폼 -->
<div class="container">
    <div class="register-card">
        <h2 class="register-title">회원가입</h2>

        <!-- 에러/성공 메시지 -->
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <form action="/register" method="post" id="registerForm">
            <div class="form-group">
                <label for="username">아이디 <span class="required">*</span></label>
                <input type="text" id="username" name="username" required>
                <div class="form-help">4~20자의 영문, 숫자만 사용 가능</div>
                <div class="validation-msg" id="usernameMsg"></div>
            </div>

            <div class="form-group">
                <label for="password">비밀번호 <span class="required">*</span></label>
                <input type="password" id="password" name="password" required>
                <div class="form-help">8~20자, 영문·숫자·특수문자 모두 포함</div>
                <div class="validation-msg" id="passwordMsg"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">비밀번호 확인 <span class="required">*</span></label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
                <div class="validation-msg" id="confirmPasswordMsg"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="name">이름 <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required>
                    <div class="validation-msg" id="nameMsg"></div>
                </div>

                <div class="form-group">
                    <label for="phone">전화번호 <span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" placeholder="010-0000-0000" required>
                    <div class="validation-msg" id="phoneMsg"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="email">이메일 <span class="required">*</span></label>
                <input type="email" id="email" name="email" placeholder="example@email.com" required>
                <div class="validation-msg" id="emailMsg"></div>
            </div>

            <button type="submit" class="register-btn" id="submitBtn">회원가입</button>
        </form>

        <div class="login-link">
            <p>이미 계정이 있으신가요? <a href="/">로그인</a></p>
        </div>
    </div>
</div>

<script>
    // register.html의 <script> 태그 내용을 다음으로 전체 교체하세요

    // 실시간 유효성 검사
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('registerForm');
        const submitBtn = document.getElementById('submitBtn');

        // 입력 필드들
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        const name = document.getElementById('name');
        const phone = document.getElementById('phone');
        const email = document.getElementById('email');

        // 메시지 요소들
        const usernameMsg = document.getElementById('usernameMsg');
        const passwordMsg = document.getElementById('passwordMsg');
        const confirmPasswordMsg = document.getElementById('confirmPasswordMsg');
        const nameMsg = document.getElementById('nameMsg');
        const phoneMsg = document.getElementById('phoneMsg');
        const emailMsg = document.getElementById('emailMsg');

        // 유효성 상태 추적
        let validationStates = {
            username: false,
            password: false,
            confirmPassword: false,
            name: false,
            phone: false,
            email: false
        };

        // 유효성 검사 함수들
        function validateUsername() {
            const value = username.value.trim();
            if (!value) {
                showValidation(usernameMsg, '', 'error');
                validationStates.username = false;
                return false;
            }
            if (value.length < 4 || value.length > 20) {
                showValidation(usernameMsg, '4~20자 사이여야 합니다', 'error');
                validationStates.username = false;
                return false;
            }
            if (!/^[a-zA-Z0-9]+$/.test(value)) {
                showValidation(usernameMsg, '영문, 숫자만 사용 가능합니다', 'error');
                validationStates.username = false;
                return false;
            }

            // 서버에 중복 체크 요청
            showValidation(usernameMsg, '확인 중...', 'checking');

            fetch(`/api/check-username?username=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        showValidation(usernameMsg, data.message, 'success');
                        validationStates.username = true;
                    } else {
                        showValidation(usernameMsg, data.message, 'error');
                        validationStates.username = false;
                    }
                    updateSubmitButton();
                })
                .catch(error => {
                    showValidation(usernameMsg, '아이디 확인 중 오류가 발생했습니다', 'error');
                    validationStates.username = false;
                    updateSubmitButton();
                });

            return true; // 일단 기본 유효성은 통과
        }

        function validatePassword() {
            const value = password.value;
            if (!value) {
                showValidation(passwordMsg, '', 'error');
                validationStates.password = false;
                return false;
            }
            if (value.length < 8 || value.length > 20) {
                showValidation(passwordMsg, '8~20자 사이여야 합니다', 'error');
                validationStates.password = false;
                return false;
            }
            const hasLetter = /[a-zA-Z]/.test(value);
            const hasDigit = /\d/.test(value);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(value);

            if (!hasLetter || !hasDigit || !hasSpecial) {
                showValidation(passwordMsg, '영문, 숫자, 특수문자를 모두 포함해야 합니다', 'error');
                validationStates.password = false;
                return false;
            }
            showValidation(passwordMsg, '안전한 비밀번호입니다', 'success');
            validationStates.password = true;
            return true;
        }

        function validateConfirmPassword() {
            const value = confirmPassword.value;
            if (!value) {
                showValidation(confirmPasswordMsg, '', 'error');
                validationStates.confirmPassword = false;
                return false;
            }
            if (value !== password.value) {
                showValidation(confirmPasswordMsg, '비밀번호가 일치하지 않습니다', 'error');
                validationStates.confirmPassword = false;
                return false;
            }
            showValidation(confirmPasswordMsg, '비밀번호가 일치합니다', 'success');
            validationStates.confirmPassword = true;
            return true;
        }

        function validateName() {
            const value = name.value.trim();
            if (!value) {
                showValidation(nameMsg, '', 'error');
                validationStates.name = false;
                return false;
            }
            if (value.length < 2 || value.length > 10) {
                showValidation(nameMsg, '2~10자 사이여야 합니다', 'error');
                validationStates.name = false;
                return false;
            }
            if (!/^[가-힣a-zA-Z\s]+$/.test(value)) {
                showValidation(nameMsg, '한글, 영문만 사용 가능합니다', 'error');
                validationStates.name = false;
                return false;
            }
            showValidation(nameMsg, '올바른 이름입니다', 'success');
            validationStates.name = true;
            return true;
        }

        function validatePhone() {
            const value = phone.value.trim();
            if (!value) {
                showValidation(phoneMsg, '', 'error');
                validationStates.phone = false;
                return false;
            }
            if (!/^010-\d{4}-\d{4}$/.test(value)) {
                showValidation(phoneMsg, '010-0000-0000 형식으로 입력해주세요', 'error');
                validationStates.phone = false;
                return false;
            }
            showValidation(phoneMsg, '올바른 전화번호입니다', 'success');
            validationStates.phone = true;
            return true;
        }

        function validateEmail() {
            const value = email.value.trim();
            if (!value) {
                showValidation(emailMsg, '', 'error');
                validationStates.email = false;
                return false;
            }
            const emailPattern = /^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
            if (!emailPattern.test(value)) {
                showValidation(emailMsg, '올바른 이메일 형식을 입력해주세요', 'error');
                validationStates.email = false;
                return false;
            }

            // 이메일 중복 체크
            showValidation(emailMsg, '확인 중...', 'checking');

            fetch(`/api/check-email?email=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        showValidation(emailMsg, data.message, 'success');
                        validationStates.email = true;
                    } else {
                        showValidation(emailMsg, data.message, 'error');
                        validationStates.email = false;
                    }
                    updateSubmitButton();
                })
                .catch(error => {
                    showValidation(emailMsg, '이메일 확인 중 오류가 발생했습니다', 'error');
                    validationStates.email = false;
                    updateSubmitButton();
                });

            return true;
        }

        function showValidation(element, message, type) {
            element.textContent = message;
            element.className = `validation-msg ${type}`;
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const allValid = Object.values(validationStates).every(state => state === true);
            submitBtn.disabled = !allValid;
        }

        // 실시간 검사 이벤트 리스너들
        username.addEventListener('input', function() {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                if (this.value.length >= 4) {
                    validateUsername();
                } else if (this.value.length > 0) {
                    showValidation(usernameMsg, '4자 이상 입력해주세요', 'error');
                    validationStates.username = false;
                }
            }, 500); // 0.5초 딜레이
        });

        password.addEventListener('blur', validatePassword);
        confirmPassword.addEventListener('blur', validateConfirmPassword);
        name.addEventListener('blur', validateName);
        phone.addEventListener('blur', validatePhone);

        email.addEventListener('blur', function() {
            if (this.value.trim()) {
                validateEmail();
            }
        });

        // 비밀번호 확인은 비밀번호 변경될 때마다 재검사
        password.addEventListener('input', function() {
            if (confirmPassword.value) {
                validateConfirmPassword();
            }
        });

        // 전화번호 자동 하이픈 추가
        phone.addEventListener('input', function() {
            let value = this.value.replace(/[^0-9]/g, '');
            if (value.length >= 3 && value.length <= 7) {
                value = value.replace(/(\d{3})(\d+)/, '$1-$2');
            } else if (value.length > 7) {
                value = value.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
            }
            this.value = value;
        });

        // 폼 제출 시 전체 유효성 검사
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // 모든 필드 재검증
            const isUsernameValid = validateUsername();
            const isPasswordValid = validatePassword();
            const isConfirmPasswordValid = validateConfirmPassword();
            const isNameValid = validateName();
            const isPhoneValid = validatePhone();
            const isEmailValid = validateEmail();

            // 서버 검증이 필요한 필드들은 상태를 확인
            if (validationStates.username && validationStates.password &&
                validationStates.confirmPassword && validationStates.name &&
                validationStates.phone && validationStates.email) {

                // 제출 버튼 비활성화
                submitBtn.disabled = true;
                submitBtn.textContent = '가입 중...';

                // 폼 제출
                this.submit();
            } else {
                alert('입력 정보를 확인해주세요.');
            }
        });

        // 초기 버튼 상태 설정
        updateSubmitButton();
    });
</script>
</body>
</html>